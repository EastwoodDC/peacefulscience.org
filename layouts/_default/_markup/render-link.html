
{{ $resolve := partial "resolve-url" . }}
{{- $dest := $resolve.Destination -}}

{{- if and (in $dest  "https://doi.org/") (not .Text )  -}}
  {{- partial "doi" $dest -}}
{{- else -}}

{{- $class := default nil -}}
{{- $target :=  default nil -}}
{{- $data := default nil -}}
{{- $tag := $resolve.Tag -}}
{{- $rel := $resolve.Rel -}}
{{- $tooltip := $resolve.Tooltip -}}

{{- if eq $resolve.Type "internal" }}
  {{- $class = "" -}}
{{- end }}

{{- if eq $resolve.Type "external" }}
  {{- $class = "external-link" -}}
  {{- $rel = "noopener nofollow" -}}
  {{- $target = "_blank" -}}
{{- end }}

{{- if eq $resolve.Type "pdf" }}
  {{- $class = "external-link" -}}
  {{- $rel = "noopener nofollow" -}}
  {{- $target = "_blank" -}}
{{- end }}

{{- if eq $resolve.Type "forum" }}
  {{- $class = "forum-link" -}}
  {{- $target = "_blank" -}}
{{- end }}

{{- if not .Text -}}
  {{- warnf "EMPTY.LINK:\t%s" $.Page.Path -}}
{{- end -}}

{{- $scratch := $.Page.Scratch -}}

{{- with  $resolve.Amazon }}
  {{- $scratch.Add "Amazon" (slice .) -}}
{{- end -}}

{{- $scratch.Add "Links" (slice $dest) -}}
{{- $num :=   ( $scratch.Get "Links" | len ) -}}

{{- with getenv "HUGO_LINKS" -}}
  {{- warnf "LINK\t%s\t%s"  $.Page.RelPermalink $dest -}}
{{- end -}}

<span
{{- with $tooltip }} data-tooltip-title="{{ . | plainify  }}" data-tooltip-position="top" class="tooltip"{{- end -}}
><a href="{{- $dest -}}{{- $tag }}"
{{-  with $data }} data-toggle="tooltip" data-placement="bottom" data-html="true" title="{{- $data -}}" {{- end -}}
{{- with $target }} target='{{- $target -}}'{{- end -}}
{{- with $rel }} rel='{{- $rel -}}'{{- end -}}
{{- with $class }} class='{{- $class -}}'{{- end -}}
{{- with $class }} class='{{- $class -}}'{{- end -}} 
{{- with .Title }} title="{{- . -}}" {{- end -}}
>{{- .Text | safeHTML }}<sup class="link-ref d-none d-print-inline">{{- $num | partial "letternum"  -}}</sup></a></span>
{{- end -}}
