{{- $dest := .Destination -}}
{{- with index site.Data.urlmap $dest -}}
  {{- $dest = . -}} 
{{- end -}}

{{- if and (in $dest  "https://doi.org/") (not .Text )  -}}
  {{- partial "doi" $dest -}}
{{ else }}

{{- $url := urls.Parse ( $dest | absURL ) -}}
{{- $basehost := (urls.Parse site.BaseURL).Host -}}
{{- $class := default nil -}}
{{- $rel := default nil -}}
{{- $target :=  default nil -}}
{{- $data := default nil -}}

{{- if in (slice "peacefulscience.org" $basehost) $url.Host -}}
  {{- $path := replaceRE ".*//peacefulscience.org" "" $dest -}}
  {{- $path := replaceRE (printf ".*//%s"  $basehost) "" $path -}}
  {{- $path := replaceRE "/$" "" $path -}}
  {{- with site.GetPage $path -}}
    {{- $dest = .Permalink -}}
    {{/*- warnf "Remapped internal link: %s\t%s\t%s" $.Page.File.Path ($path ) $dest -*/}}
    
  {{- else -}}
    {{- if  (findRE "pdf$" $path) -}}

       {{ $pdf := $path }}
       {{- $pdffile := printf "static%s" $pdf  -}}
       {{- $pdfdest:= printf "%s" $pdf | absURL -}}
       {{- if fileExists $pdffile  -}}
          {{- $dest = $pdfdest -}}  
          {{- $class = "external-link" -}}
       {{- else -}}
          {{- warnf "BROKEN.PDF:\t%s\t%s\t%s" $.Page.File.Path $pdf $pdffile -}}      
       {{- end -}}
    {{- else -}}
      {{- warnf "BROKEN.LINK:\t%s\t%s" $.Page.File.Path $dest -}}
    {{- end -}}
  {{- end -}}
{{ else }}
  {{- $class = "external-link" -}}
  {{- $rel = "noopener nofollow" -}}
  {{- $target = "_blank" -}}
{{- end -}}


{{- if eq $url.Host "discourse.peacefulscience.org" -}}
  {{- $class = "forum-link" -}}
{{- end -}}

{{- if eq $url.Host "www.amazon.com" -}}
  {{- $dest = printf "https://www.amazon.com%s?%s" $url.Path "tag=swamidass-20" -}}
  {{- $rel = "sponsored" -}}  
{{- end -}}

<a href="{{ $dest }}"
{{-  with $data }} data-toggle="tooltip" data-placement="bottom" data-html="true" title="{{ $data }}" {{ end -}}
{{- with $target }} target='{{ $target }}'{{- end -}}
{{- with $rel }} rel='{{ $rel }}'{{- end -}}
{{- with $class }} class='{{ $class }}'{{- end -}}
{{- with .Title }} title="{{ . }}" {{- end -}}
>{{ .Text | safeHTML}}</a>
{{- end -}}